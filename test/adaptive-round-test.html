<!DOCTYPE html>
<html>
<head>
  <title>Adaptive Round Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #444;
      border-radius: 4px;
    }
    .pass { color: #4ec9b0; }
    .fail { color: #f48771; }
    h2 { color: #569cd6; }
    pre { 
      background: #252526;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Adaptive Round Class Tests</h1>
  <div id="output"></div>

  <script type="module">
    // Test with bundled version (heavy)
    import { CharacterLoader as HeavyCharacterLoader, Round } from '../dist/swordfight-engine.js';
    
    const output = document.getElementById('output');
    
    function log(message, isError = false) {
      const div = document.createElement('div');
      div.innerHTML = message;
      div.className = isError ? 'fail' : '';
      output.appendChild(div);
    }

    // Mock game object
    const mockGame = {
      rounds: [],
      roundNumber: 0
    };

    async function testBundledMode() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.innerHTML = '<h2>Test 1: Bundled Mode (Heavy Version)</h2>';
      output.appendChild(section);
      
      try {
        // Load characters with bundled data
        const char1 = await HeavyCharacterLoader.getCharacter('human-fighter');
        const char2 = await HeavyCharacterLoader.getCharacter('evil-human-fighter');
        
        const move1 = char1.moves.find(m => m.id === '62');
        const move2 = char2.moves.find(m => m.id === '62');
        
        log(`‚úì Loaded characters`);
        log(`‚úì Character has tables: ${!!char1.tables}`);
        log(`‚úì Character has results: ${!!char1.results}`);
        
        // Create round
        const round = new Round(mockGame, move1, move2, char1, char2);
        
        log(`‚úì Round created`);
        log(`‚úì Using API mode: ${round.useApi}`);
        
        if (round.useApi) {
          log('‚úó ERROR: Should not use API mode with bundled data', true);
          return false;
        }
        
        log(`‚úì Outcome: ${round.outcome}`);
        log(`‚úì Result: ${round.result?.name}`);
        log(`‚úì Total Score: ${round.totalScore}`);
        
        if (!round.outcome || !round.result) {
          log('‚úó ERROR: Round not properly initialized', true);
          return false;
        }
        
        log('<strong class="pass">‚úÖ BUNDLED MODE PASSED</strong>');
        return true;
      } catch (error) {
        log(`‚úó ERROR: ${error.message}`, true);
        log(`<pre>${error.stack}</pre>`, true);
        return false;
      }
    }

    async function testApiMode() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.innerHTML = '<h2>Test 2: API Mode (Lite Version)</h2>';
      output.appendChild(section);
      
      try {
        // Simulate API-loaded characters (no tables/results)
        const char1 = {
          name: 'Human Fighter',
          slug: 'human-fighter',
          health: 12,
          moves: [
            { id: '62', name: 'Jump Back', tag: 'Extended Range', mod: '-6' }
          ]
        };
        
        const char2 = {
          name: 'Evil Human Fighter',
          slug: 'evil-human-fighter',
          health: 12,
          moves: [
            { id: '62', name: 'Jump Back', tag: 'Extended Range', mod: '-6' }
          ]
        };
        
        const move1 = char1.moves[0];
        const move2 = char2.moves[0];
        
        log(`‚úì Created API-style characters (no tables/results)`);
        log(`‚úì Character has tables: ${!!char1.tables}`);
        log(`‚úì Character has results: ${!!char1.results}`);
        
        // Set API base
        Round.setApiBase('https://api.swordfight.me');
        log(`‚úì Set API base to https://api.swordfight.me`);
        
        // Create round
        const round = new Round(mockGame, move1, move2, char1, char2);
        log(`‚úì Round created`);
        log(`‚úì Using API mode: ${round.useApi}`);
        
        if (!round.useApi) {
          log('‚úó ERROR: Should use API mode without tables/results', true);
          return false;
        }
        
        // Initialize from API
        log('Fetching round data from API...');
        await round.init();
        
        log(`‚úì Outcome: ${round.outcome}`);
        log(`‚úì Result: ${round.result?.name}`);
        log(`‚úì Total Score: ${round.totalScore}`);
        
        if (!round.outcome || !round.result) {
          log('‚úó ERROR: Round not properly initialized from API', true);
          return false;
        }
        
        log('<strong class="pass">‚úÖ API MODE PASSED</strong>');
        return true;
      } catch (error) {
        log(`‚úó ERROR: ${error.message}`, true);
        log(`<pre>${error.stack}</pre>`, true);
        return false;
      }
    }

    async function runTests() {
      const bundledResult = await testBundledMode();
      const apiResult = await testApiMode();
      
      const summary = document.createElement('div');
      summary.className = 'test-section';
      summary.innerHTML = '<h2>Test Summary</h2>';
      
      if (bundledResult && apiResult) {
        summary.innerHTML += '<h3 class="pass">üéâ All tests passed! Round class is fully adaptive.</h3>';
      } else {
        summary.innerHTML += '<h3 class="fail">‚ùå Some tests failed</h3>';
      }
      
      output.appendChild(summary);
    }

    runTests();
  </script>
</body>
</html>
